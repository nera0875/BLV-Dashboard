{% extends "base.html" %}

{% block title %}Burp Parser - BLV Dashboard{% endblock %}

{% block content %}
<div x-data="burpParserApp()" x-init="init()" class="max-w-7xl mx-auto">

    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm border border-zinc-200 p-6 mb-6">
        <h2 class="text-2xl font-bold text-zinc-900">Burp Suite Request Parser</h2>
        <p class="text-sm text-zinc-500 mt-2">
            Paste raw HTTP requests from Burp Suite to automatically parse and store them in the database.
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Input Panel -->
        <div class="bg-white rounded-lg shadow-sm border border-zinc-200 p-6">
            <h3 class="font-semibold text-zinc-900 mb-4">Paste HTTP Request</h3>

            <textarea
                x-model="rawRequest"
                class="textarea textarea-bordered w-full h-96 font-mono text-xs"
                placeholder="POST /graphql/ HTTP/2
Host: www.example.com
Cookie: session=abc123
Content-Type: application/json

{&quot;query&quot;: &quot;...&quot;}"
            ></textarea>

            <div class="mt-4 flex gap-3">
                <button
                    @click="parseRequest()"
                    class="btn bg-zinc-900 text-white hover:bg-zinc-800"
                    :disabled="!rawRequest.trim() || parsing"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    Parse & Save
                </button>

                <button
                    @click="clearInput()"
                    class="btn btn-ghost"
                >
                    Clear
                </button>

                <div x-show="parsed" x-transition class="flex items-center text-green-600 ml-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Parsed successfully!
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="bg-white rounded-lg shadow-sm border border-zinc-200 p-6">
            <h3 class="font-semibold text-zinc-900 mb-4">Parsed Data Preview</h3>

            <div x-show="!currentParsed" class="text-center text-zinc-400 py-20">
                No data parsed yet
            </div>

            <div x-show="currentParsed" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-semibold text-zinc-600">Method</label>
                        <div class="bg-zinc-50 border border-zinc-200 rounded px-3 py-2 mt-1">
                            <code class="text-sm font-bold" x-text="currentParsed?.method"></code>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-semibold text-zinc-600">Host</label>
                        <div class="bg-zinc-50 border border-zinc-200 rounded px-3 py-2 mt-1">
                            <code class="text-xs" x-text="currentParsed?.host"></code>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-semibold text-zinc-600">Full URL</label>
                    <div class="bg-zinc-50 border border-zinc-200 rounded px-3 py-2 mt-1 overflow-x-auto">
                        <code class="text-xs" x-text="currentParsed?.url"></code>
                    </div>
                </div>

                <div x-show="currentParsed?.graphql_operation">
                    <label class="text-xs font-semibold text-zinc-600">GraphQL Operation</label>
                    <div class="bg-blue-50 border border-blue-200 rounded px-3 py-2 mt-1">
                        <code class="text-sm font-bold text-blue-900" x-text="currentParsed?.graphql_operation"></code>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-semibold text-zinc-600">Headers</label>
                    <div class="bg-zinc-50 border border-zinc-200 rounded p-3 mt-1 max-h-32 overflow-y-auto">
                        <template x-for="(value, key) in currentParsed?.headers_json" :key="key">
                            <div class="text-xs mb-1">
                                <span class="font-semibold text-zinc-700" x-text="key + ':'"></span>
                                <span class="text-zinc-600 ml-2" x-text="value"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="currentParsed?.body">
                    <label class="text-xs font-semibold text-zinc-600">Body</label>
                    <div class="bg-zinc-50 border border-zinc-200 rounded p-3 mt-1 max-h-32 overflow-y-auto">
                        <pre class="text-xs text-zinc-700" x-text="formatBody(currentParsed?.body)"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History -->
    <div class="mt-6 bg-white rounded-lg shadow-sm border border-zinc-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-zinc-900">Request History</h3>
            <button
                @click="loadHistory()"
                class="btn btn-sm btn-ghost"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Refresh
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="table table-sm">
                <thead>
                    <tr class="text-zinc-900">
                        <th>ID</th>
                        <th>Method</th>
                        <th>Host</th>
                        <th>Path</th>
                        <th>GraphQL Op</th>
                        <th>Parsed At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="req in history" :key="req.id">
                        <tr class="hover">
                            <td><code class="text-xs" x-text="req.id"></code></td>
                            <td>
                                <span
                                    class="badge badge-sm"
                                    :class="{
                                        'badge-success': req.method === 'GET',
                                        'badge-info': req.method === 'POST',
                                        'badge-warning': req.method === 'PUT',
                                        'badge-error': req.method === 'DELETE'
                                    }"
                                    x-text="req.method"
                                ></span>
                            </td>
                            <td><code class="text-xs" x-text="req.host"></code></td>
                            <td><code class="text-xs truncate max-w-xs" x-text="req.path"></code></td>
                            <td>
                                <code class="text-xs text-blue-600" x-text="req.graphql_operation || '-'"></code>
                            </td>
                            <td class="text-xs text-zinc-500" x-text="new Date(req.parsed_at).toLocaleString()"></td>
                            <td>
                                <button
                                    @click="viewRequest(req)"
                                    class="btn btn-xs btn-ghost"
                                >
                                    View
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>

            <div x-show="history.length === 0" class="text-center text-zinc-400 py-8">
                No requests parsed yet
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function burpParserApp() {
    return {
        rawRequest: '',
        currentParsed: null,
        history: [],
        parsing: false,
        parsed: false,

        async init() {
            await this.loadHistory();
        },

        async parseRequest() {
            if (!this.rawRequest.trim()) return;

            this.parsing = true;
            this.parsed = false;

            try {
                const res = await fetch('/api/burp/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ raw_request: this.rawRequest })
                });

                const data = await res.json();

                if (res.ok) {
                    this.currentParsed = data.request;
                    this.parsed = true;
                    setTimeout(() => this.parsed = false, 3000);
                    await this.loadHistory();
                    this.rawRequest = '';
                } else {
                    alert('Failed to parse request: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                this.parsing = false;
            }
        },

        async loadHistory() {
            try {
                const res = await fetch('/api/burp/requests?limit=50');
                this.history = await res.json();
            } catch (e) {
                console.error('Failed to load history:', e);
            }
        },

        viewRequest(req) {
            this.currentParsed = req;
        },

        clearInput() {
            this.rawRequest = '';
            this.currentParsed = null;
        },

        formatBody(body) {
            try {
                const json = JSON.parse(body);
                return JSON.stringify(json, null, 2);
            } catch {
                return body;
            }
        }
    }
}
</script>
{% endblock %}
